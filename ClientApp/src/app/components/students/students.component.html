<div class="students-container">
  
  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">
      <span class="icon">ğŸ‘¨â€ğŸ“</span>
      Quáº£n lÃ½ Sinh viÃªn
    </h1>
  </div>

  <!-- Success/Error Messages -->
  <div class="alert alert-success" *ngIf="successMessage">
    <span class="alert-icon">âœ“</span>
    {{ successMessage }}
  </div>
  
  <div class="alert alert-error" *ngIf="errorMessage">
    <span class="alert-icon">âœ•</span>
    {{ errorMessage }}
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="filters-row">
      <!-- Search -->
      <div class="search-box">
        <input 
          type="text" 
          class="search-input" 
          placeholder="TÃ¬m kiáº¿m theo mÃ£ SV hoáº·c há» tÃªn..."
          [(ngModel)]="searchString"
          (keyup.enter)="search()"
        />
        <button class="btn btn-icon" (click)="search()" *ngIf="!searchString">
          <span class="icon">ğŸ”</span>
        </button>
        <button class="btn btn-icon" (click)="clearSearch()" *ngIf="searchString">
          <span class="icon">âœ•</span>
        </button>
      </div>

      <!-- Department Filter -->
      <select class="filter-select" [(ngModel)]="selectedDepartmentId" (change)="onDepartmentChange()">
        <option value="">Táº¥t cáº£ khoa</option>
        <option *ngFor="let dept of departments" [value]="dept.departmentId">
          {{ dept.departmentName }}
        </option>
      </select>

      <!-- Class Filter -->
      <select class="filter-select" [(ngModel)]="selectedClassId" (change)="onClassChange()">
        <option value="">Táº¥t cáº£ lá»›p</option>
        <option *ngFor="let cls of filteredClasses" [value]="cls.classId">
          {{ cls.className }}
        </option>
      </select>
    </div>

    <div class="actions-row">
      <button class="btn btn-success" (click)="exportToExcel()" *ngIf="userRole === 'Admin' || userRole === 'Teacher'">
        <span class="icon">ğŸ“Š</span>
        Xuáº¥t Excel
      </button>

      <button class="btn btn-warning" (click)="exportToPdf()" *ngIf="userRole === 'Admin' || userRole === 'Teacher'">
        <span class="icon">ğŸ“„</span>
        Xuáº¥t PDF
      </button>

      <button class="btn btn-primary" (click)="openAddModal()" *ngIf="userRole === 'Admin' || userRole === 'Teacher'">
        <span class="icon">+</span>
        ThÃªm sinh viÃªn
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Äang táº£i dá»¯ liá»‡u...</p>
  </div>

  <!-- Students Table -->
  <div class="table-container" *ngIf="!isLoading">
    <table class="data-table">
      <thead>
        <tr>
          <th>STT</th>
          <th>MÃ£ SV</th>
          <th>Há» tÃªn</th>
          <th>NgÃ y sinh</th>
          <th>Giá»›i tÃ­nh</th>
          <th>Lá»›p</th>
          <th>Khoa</th>
          <th>Sá»‘ Ä‘iá»‡n thoáº¡i</th>
          <th class="text-center" *ngIf="userRole === 'Admin' || userRole === 'Teacher'">Thao tÃ¡c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let student of students; let i = index">
          <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
          <td><strong>{{ student.studentId }}</strong></td>
          <td>{{ student.fullName }}</td>
          <td>{{ student.dateOfBirth | date: 'dd/MM/yyyy' }}</td>
          <td>
            <span class="badge" [class.badge-male]="student.gender" [class.badge-female]="!student.gender">
              {{ getGenderText(student.gender) }}
            </span>
          </td>
          <td>{{ student.className }}</td>
          <td>{{ student.departmentName }}</td>
          <td>{{ student.phone }}</td>
          <td class="text-center" *ngIf="userRole === 'Admin' || userRole === 'Teacher'">
            <div class="action-buttons">
              <button class="btn-action btn-edit" (click)="openEditModal(student)" title="Chá»‰nh sá»­a">
                <span class="icon">âœï¸</span>
              </button>
              <button class="btn-action btn-delete" (click)="openDeleteConfirm(student)" title="XÃ³a" *ngIf="userRole === 'Admin'">
                <span class="icon">ğŸ—‘ï¸</span>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="students.length === 0">
          <td [attr.colspan]="userRole === 'Admin' || userRole === 'Teacher' ? 9 : 8" class="text-center empty-state">
            <div class="empty-icon">ğŸ“‚</div>
            <p>KhÃ´ng cÃ³ dá»¯ liá»‡u</p>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button class="btn-page" (click)="onPageChange(1)" [disabled]="currentPage === 1">
        â®ï¸
      </button>
      <button class="btn-page" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1">
        â—€ï¸
      </button>
      
      <span class="page-info">
        Trang <strong>{{ currentPage }}</strong> / {{ totalPages }} (Tá»•ng: {{ totalCount }} sinh viÃªn)
      </span>
      
      <button class="btn-page" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages">
        â–¶ï¸
      </button>
      <button class="btn-page" (click)="onPageChange(totalPages)" [disabled]="currentPage === totalPages">
        â­ï¸
      </button>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="icon">{{ isEditMode ? 'âœï¸' : 'â•' }}</i>
          {{ isEditMode ? 'Sá»­a Sinh ViÃªn' : 'ThÃªm Sinh ViÃªn' }}
        </h2>
        <button class="modal-close" (click)="closeModal()">Ã—</button>
      </div>
      
      <div class="modal-body">
        <form class="teacher-form">
          <div class="form-grid">
            <!-- Student ID -->
            <div class="form-group">
              <label class="form-label required">MÃ£ Sinh ViÃªn</label>
              <input 
                type="text" 
                class="form-input"
                [class.error]="validationErrors.studentId"
                [(ngModel)]="currentStudent.studentId"
                name="studentId"
                [disabled]="isEditMode"
                maxlength="10"
                placeholder="Nháº­p mÃ£ sinh viÃªn"
              />
              <small class="error-text" *ngIf="validationErrors.studentId">
                {{ validationErrors.studentId }}
              </small>
            </div>

            <!-- Full Name -->
            <div class="form-group">
              <label class="form-label required">Há» vÃ  TÃªn</label>
              <input 
                type="text" 
                class="form-input"
                [class.error]="validationErrors.fullName"
                [(ngModel)]="currentStudent.fullName"
                name="fullName"
                maxlength="100"
                placeholder="Nháº­p há» vÃ  tÃªn"
              />
              <small class="error-text" *ngIf="validationErrors.fullName">
                {{ validationErrors.fullName }}
              </small>
            </div>

            <!-- Date of Birth -->
            <div class="form-group">
              <label class="form-label required">NgÃ y Sinh</label>
              <input 
                type="date" 
                class="form-input"
                [class.error]="validationErrors.dateOfBirth"
                [(ngModel)]="currentStudent.dateOfBirth"
                name="dateOfBirth"
              />
              <small class="error-text" *ngIf="validationErrors.dateOfBirth">
                {{ validationErrors.dateOfBirth }}
              </small>
            </div>

            <!-- Gender -->
            <div class="form-group">
              <label class="form-label required">Giá»›i TÃ­nh</label>
              <div class="gender-toggle">
                <button 
                  type="button"
                  class="gender-btn" 
                  [class.active]="currentStudent.gender === true"
                  (click)="currentStudent.gender = true"
                >
                  ğŸ‘¨ Nam
                </button>
                <button 
                  type="button"
                  class="gender-btn" 
                  [class.active]="currentStudent.gender === false"
                  (click)="currentStudent.gender = false"
                >
                  ğŸ‘© Ná»¯
                </button>
              </div>
            </div>

            <!-- Phone -->
            <div class="form-group">
              <label class="form-label">Sá»‘ Äiá»‡n Thoáº¡i</label>
              <input 
                type="tel" 
                class="form-input"
                [(ngModel)]="currentStudent.phone"
                name="phone"
                maxlength="15"
                placeholder="Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i"
              />
            </div>

            <!-- Address -->
            <div class="form-group">
              <label class="form-label">Äá»‹a Chá»‰</label>
              <input 
                type="text" 
                class="form-input"
                [(ngModel)]="currentStudent.address"
                name="address"
                maxlength="200"
                placeholder="Nháº­p Ä‘á»‹a chá»‰"
              />
            </div>

            <!-- Class -->
            <div class="form-group">
              <label class="form-label required">Khoa</label>
              <select 
                class="form-input"
                [class.error]="validationErrors.classId"
                [(ngModel)]="currentStudent.classId"
                name="classId"
              >
                <option value="">-- Chá»n lá»›p --</option>
                <option *ngFor="let cls of classes" [value]="cls.classId">
                  {{ cls.className }}
                </option>
              </select>
              <small class="error-text" *ngIf="validationErrors.classId">
                {{ validationErrors.classId }}
              </small>
            </div>

            <!-- Username (only for add mode) -->
            <div class="form-group" *ngIf="!isEditMode">
              <label class="form-label required">TÃªn ÄÄƒng Nháº­p</label>
              <input 
                type="text" 
                class="form-input"
                [class.error]="validationErrors.username"
                [(ngModel)]="currentStudent.username"
                name="username"
                maxlength="50"
                placeholder="Nháº­p tÃªn Ä‘Äƒng nháº­p"
              />
              <small class="error-text" *ngIf="validationErrors.username">
                {{ validationErrors.username }}
              </small>
            </div>

            <!-- Password (only for add mode) -->
            <div class="form-group" *ngIf="!isEditMode">
              <label class="form-label required">Máº­t Kháº©u</label>
              <input 
                type="password" 
                class="form-input"
                [class.error]="validationErrors.password"
                [(ngModel)]="currentStudent.password"
                name="password"
                maxlength="100"
                placeholder="Nháº­p máº­t kháº©u"
              />
              <small class="error-text" *ngIf="validationErrors.password">
                {{ validationErrors.password }}
              </small>
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          <i class="icon">âœ–ï¸</i> Há»§y
        </button>
        <button type="button" class="btn btn-primary" (click)="saveStudent()">
          <i class="icon">{{ isEditMode ? 'ğŸ’¾' : 'â•' }}</i>
          {{ isEditMode ? 'Cáº­p Nháº­t' : 'ThÃªm Má»›i' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showDeleteConfirm" (click)="closeDeleteConfirm()">
    <div class="modal-content modal-small" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">XÃ¡c nháº­n xÃ³a</h2>
        <button class="modal-close" (click)="closeDeleteConfirm()">âœ•</button>
      </div>
      
      <div class="modal-body">
        <div class="confirm-message">
          <div class="confirm-icon">âš ï¸</div>
          <p>Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a sinh viÃªn <strong>{{ studentToDelete?.fullName }}</strong>?</p>
          
          <!-- Hiá»ƒn thá»‹ warning náº¿u sinh viÃªn cÃ²n Ä‘iá»ƒm -->
          <div *ngIf="studentToDelete && studentToDelete.gradeCount && studentToDelete.gradeCount > 0" class="alert alert-warning">
            <p class="text-danger">
              <strong>âš ï¸ Cáº£nh bÃ¡o:</strong> Sinh viÃªn nÃ y cÃ³ <strong>{{ studentToDelete.gradeCount }}</strong> Ä‘iá»ƒm sá»‘.
            </p>
            <p class="text-danger">Báº¡n cáº§n xÃ³a táº¥t cáº£ Ä‘iá»ƒm trÆ°á»›c khi xÃ³a sinh viÃªn.</p>
          </div>
          
          <p *ngIf="!studentToDelete || !studentToDelete.gradeCount || studentToDelete.gradeCount === 0" class="text-warning">
            HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c!
          </p>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDeleteConfirm()">Há»§y</button>
        
        <!-- NÃºt xÃ³a táº¥t cáº£ Ä‘iá»ƒm (chá»‰ hiá»‡n náº¿u cÃ³ Ä‘iá»ƒm) -->
        <button 
          *ngIf="studentToDelete && studentToDelete.gradeCount && studentToDelete.gradeCount > 0"
          class="btn btn-warning" 
          (click)="deleteAllGrades()">
          ğŸ—‘ï¸ XÃ³a táº¥t cáº£ {{ studentToDelete.gradeCount }} Ä‘iá»ƒm
        </button>
        
        <!-- NÃºt xÃ³a sinh viÃªn (disable náº¿u cÃ²n Ä‘iá»ƒm) -->
        <button 
          class="btn btn-danger" 
          (click)="confirmDelete()"
          [disabled]="studentToDelete && studentToDelete.gradeCount && studentToDelete.gradeCount > 0">
          {{ (studentToDelete && studentToDelete.gradeCount && studentToDelete.gradeCount > 0) ? 'ğŸ”’ KhÃ´ng thá»ƒ xÃ³a' : 'XÃ³a sinh viÃªn' }}
        </button>
      </div>
    </div>
  </div>

</div>
