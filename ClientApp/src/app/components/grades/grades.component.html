<div class="grades-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">
      <span class="icon">ğŸ“Š</span>
      <span *ngIf="!isStudent()">Quáº£n LÃ½ Äiá»ƒm</span>
      <span *ngIf="isStudent()">Báº£ng Äiá»ƒm Cá»§a TÃ´i</span>
    </h1>
  </div>

  <!-- Alert Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    <span class="alert-icon">âœ“</span>
    <span>{{ successMessage }}</span>
  </div>

  <div *ngIf="errorMessage" class="alert alert-error">
    <span class="alert-icon">âœ•</span>
    <span>{{ errorMessage }}</span>
  </div>

  <!-- Toolbar (hidden for Student) -->
  <div class="toolbar" *ngIf="!isStudent()">
    <div class="filters-row">
      <!-- Class Filter -->
      <select class="filter-select" [(ngModel)]="selectedClassId" (change)="onClassFilterChange()">
        <option value="">Táº¥t cáº£ lá»›p</option>
        <option *ngFor="let class of classes" [value]="class.classId">
          {{ class.classId }} - {{ class.className }}
        </option>
      </select>

      <!-- Course Filter -->
      <select class="filter-select" [(ngModel)]="selectedCourseId" (change)="onCourseFilterChange()">
        <option value="">Táº¥t cáº£ mÃ´n há»c</option>
        <option *ngFor="let course of courses" [value]="course.courseId">
          {{ course.courseId }} - {{ course.courseName }}
        </option>
      </select>
    </div>

    <!-- Action Buttons -->
    <div class="actions-row">
      <button class="btn btn-primary" (click)="openAddModal()" *ngIf="canEdit()">
        <span class="icon">â•</span>
        ThÃªm Äiá»ƒm
      </button>
      <button class="btn btn-success" (click)="exportToExcel()" *ngIf="canExport()">
        <span class="icon">ğŸ“Š</span>
        Xuáº¥t Excel
      </button>
      <button class="btn btn-warning" (click)="exportToPdf()" *ngIf="canExport()">
        <span class="icon">ğŸ“„</span>
        Xuáº¥t PDF
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Äang táº£i dá»¯ liá»‡u...</p>
  </div>

  <!-- Data Table -->
  <div *ngIf="!isLoading" class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th *ngIf="!isStudent()">MÃ£ SV</th>
          <th *ngIf="!isStudent()">Há» TÃªn</th>
          <th *ngIf="!isStudent()">Lá»›p</th>
          <th>MÃ´n Há»c</th>
          <th class="text-center">Äiá»ƒm</th>
          <th class="text-center">Xáº¿p Loáº¡i</th>
          <th class="text-center" *ngIf="!isStudent()">Thao TÃ¡c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="grades.length === 0">
          <td [attr.colspan]="isStudent() ? '3' : '7'" class="empty-state">
            <div class="empty-icon">ğŸ“Š</div>
            <p>KhÃ´ng tÃ¬m tháº¥y Ä‘iá»ƒm nÃ o</p>
          </td>
        </tr>
        <tr *ngFor="let grade of grades">
          <td *ngIf="!isStudent()">{{ grade.studentId }}</td>
          <td *ngIf="!isStudent()">{{ grade.studentName }}</td>
          <td *ngIf="!isStudent()">{{ grade.className }}</td>
          <td>{{ grade.courseName }}</td>
          <td class="text-center">
            <span class="score-badge">{{ grade.score.toFixed(2) }}</span>
          </td>
          <td class="text-center">
            <span class="classification-badge" [ngClass]="getClassificationClass(grade.classification)">
              {{ grade.classification }}
            </span>
          </td>
          <td class="text-center" *ngIf="!isStudent()">
            <div class="action-buttons">
              <button 
                class="btn-action btn-edit" 
                (click)="openEditModal(grade)"
                *ngIf="canEdit()"
                title="Sá»­a"
              >
                <span class="icon">âœï¸</span>
              </button>
              <button 
                class="btn-action btn-delete" 
                (click)="openDeleteModal(grade)"
                *ngIf="canDelete()"
                title="XÃ³a"
              >
                <span class="icon">ğŸ—‘ï¸</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button class="btn-page" (click)="onPageChange(1)" [disabled]="currentPage === 1">
        â®ï¸ Äáº§u
      </button>
      <button class="btn-page" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1">
        â—€ï¸ TrÆ°á»›c
      </button>
      <span class="page-info">
        Trang <strong>{{ currentPage }}</strong> / <strong>{{ totalPages }}</strong>
        (Tá»•ng: <strong>{{ totalCount }}</strong> Ä‘iá»ƒm)
      </span>
      <button class="btn-page" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages">
        Sau â–¶ï¸
      </button>
      <button class="btn-page" (click)="onPageChange(totalPages)" [disabled]="currentPage === totalPages">
        Cuá»‘i â­ï¸
      </button>
    </div>
  </div>
</div>

<!-- Add Grade Modal -->
<div class="modal-overlay" *ngIf="showAddModal" (click)="closeAddModal()">
  <div class="modal-content modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">â• ThÃªm Äiá»ƒm Má»›i</h2>
      <button class="modal-close" (click)="closeAddModal()">âœ•</button>
    </div>
    
    <div class="modal-body">
      <form class="form-grid-single">
        <!-- Student -->
        <div class="form-group">
          <label class="form-label">
            Sinh ViÃªn <span class="required">*</span>
          </label>
          <select 
            class="form-input"
            [class.error]="validationErrors.studentId"
            [(ngModel)]="currentGrade.studentId"
            name="studentId"
            required
          >
            <option value="">-- Chá»n sinh viÃªn --</option>
            <option *ngFor="let student of students" [value]="student.studentId">
              {{ student.studentId }} - {{ student.fullName }}
            </option>
          </select>
          <small class="error-text" *ngIf="validationErrors.studentId">
            {{ validationErrors.studentId }}
          </small>
        </div>

        <!-- Course -->
        <div class="form-group">
          <label class="form-label">
            MÃ´n Há»c <span class="required">*</span>
          </label>
          <select 
            class="form-input"
            [class.error]="validationErrors.courseId"
            [(ngModel)]="currentGrade.courseId"
            name="courseId"
            required
          >
            <option value="">-- Chá»n mÃ´n há»c --</option>
            <option *ngFor="let course of courses" [value]="course.courseId">
              {{ course.courseId }} - {{ course.courseName }}
            </option>
          </select>
          <small class="error-text" *ngIf="validationErrors.courseId">
            {{ validationErrors.courseId }}
          </small>
        </div>

        <!-- Score -->
        <div class="form-group">
          <label class="form-label">
            Äiá»ƒm <span class="required">*</span>
          </label>
          <input 
            type="number" 
            class="form-input"
            [class.error]="validationErrors.score"
            [(ngModel)]="currentGrade.score"
            (input)="onScoreChange()"
            name="score"
            placeholder="Nháº­p Ä‘iá»ƒm (0-10)"
            min="0"
            max="10"
            step="0.01"
            required
          />
          <small class="error-text" *ngIf="validationErrors.score">
            {{ validationErrors.score }}
          </small>
        </div>

        <!-- Classification Preview -->
        <div class="form-group" *ngIf="previewClassification">
          <label class="form-label">Xáº¿p Loáº¡i Dá»± Kiáº¿n</label>
          <div class="classification-preview">
            <span class="classification-badge" [ngClass]="getClassificationClass(previewClassification)">
              {{ previewClassification }}
            </span>
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeAddModal()">
        Há»§y
      </button>
      <button class="btn btn-primary" (click)="saveGrade()">
        <span class="icon">ğŸ’¾</span>
        LÆ°u
      </button>
    </div>
  </div>
</div>

<!-- Edit Grade Modal -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-content modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">âœï¸ Sá»­a Äiá»ƒm</h2>
      <button class="modal-close" (click)="closeEditModal()">âœ•</button>
    </div>
    
    <div class="modal-body">
      <form class="form-grid-single">
        <!-- Student (disabled) -->
        <div class="form-group">
          <label class="form-label">Sinh ViÃªn</label>
          <input 
            type="text" 
            class="form-input"
            [value]="currentGrade.studentId + ' - ' + currentGrade.studentName"
            disabled
          />
        </div>

        <!-- Course (disabled) -->
        <div class="form-group">
          <label class="form-label">MÃ´n Há»c</label>
          <input 
            type="text" 
            class="form-input"
            [value]="currentGrade.courseId + ' - ' + currentGrade.courseName"
            disabled
          />
        </div>

        <!-- Score -->
        <div class="form-group">
          <label class="form-label">
            Äiá»ƒm <span class="required">*</span>
          </label>
          <input 
            type="number" 
            class="form-input"
            [class.error]="validationErrors.score"
            [(ngModel)]="currentGrade.score"
            (input)="onScoreChange()"
            name="score"
            placeholder="Nháº­p Ä‘iá»ƒm (0-10)"
            min="0"
            max="10"
            step="0.01"
            required
          />
          <small class="error-text" *ngIf="validationErrors.score">
            {{ validationErrors.score }}
          </small>
        </div>

        <!-- Classification Preview -->
        <div class="form-group" *ngIf="previewClassification">
          <label class="form-label">Xáº¿p Loáº¡i Dá»± Kiáº¿n</label>
          <div class="classification-preview">
            <span class="classification-badge" [ngClass]="getClassificationClass(previewClassification)">
              {{ previewClassification }}
            </span>
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeEditModal()">
        Há»§y
      </button>
      <button class="btn btn-primary" (click)="saveGrade()">
        <span class="icon">ğŸ’¾</span>
        Cáº­p Nháº­t
      </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
  <div class="modal-content modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">âš ï¸ XÃ¡c Nháº­n XÃ³a</h2>
      <button class="modal-close" (click)="closeDeleteModal()">âœ•</button>
    </div>
    
    <div class="modal-body">
      <div class="confirm-message">
        <div class="confirm-icon">ğŸ—‘ï¸</div>
        <p>Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a Ä‘iá»ƒm:</p>
        <p><strong>{{ gradeToDelete?.studentName }} - {{ gradeToDelete?.courseName }}</strong></p>
        <p>Äiá»ƒm: <strong>{{ gradeToDelete?.score?.toFixed(2) }}</strong> - Xáº¿p loáº¡i: <strong>{{ gradeToDelete?.classification }}</strong></p>
        <p class="text-warning">âš ï¸ HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c!</p>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDeleteModal()">
        Há»§y
      </button>
      <button class="btn btn-danger" (click)="deleteGrade()">
        <span class="icon">ğŸ—‘ï¸</span>
        XÃ³a
      </button>
    </div>
  </div>
</div>
