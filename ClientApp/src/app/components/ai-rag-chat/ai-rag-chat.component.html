<!-- ğŸ¤– AI RAG Chat Box - Pro Version -->
<div class="ai-chat-container" *ngIf="isVisible" [class.minimized]="isMinimized">
  <!-- Header -->
  <div class="chat-header" (click)="toggleMinimize()">
    <div class="header-left">
      <span class="ai-icon">ğŸ¤–</span>
      <div class="header-info">
        <h3>AI Assistant</h3>
        <span class="status">{{ loading ? 'â³ Äang suy nghÄ©...' : 'âœ… Sáºµn sÃ ng' }}</span>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-icon" (click)="clearChat(); $event.stopPropagation()" title="XÃ³a chat">
        ğŸ—‘ï¸
      </button>
      <button class="btn-icon" (click)="toggleMinimize(); $event.stopPropagation()" title="Thu nhá»">
        {{ isMinimized ? 'ğŸ”¼' : 'ğŸ”½' }}
      </button>
      <button class="btn-icon" (click)="closeChat(); $event.stopPropagation()" title="ÄÃ³ng">
        âœ–ï¸
      </button>
    </div>
  </div>

  <!-- Chat Body -->
  <div class="chat-body" *ngIf="!isMinimized">
    <!-- Messages Container -->
    <div class="messages-container" #messagesContainer>
      <!-- Welcome Message -->
      <div class="welcome-message" *ngIf="messages.length === 0">
        <h2>ğŸ‘‹ Xin chÃ o!</h2>
        <p>TÃ´i lÃ  AI Assistant cho há»‡ thá»‘ng quáº£n lÃ½ sinh viÃªn</p>
        <p class="welcome-subtitle">TÃ´i cÃ³ thá»ƒ giÃºp báº¡n:</p>
        <ul>
          <li>ğŸ” Giáº£i thÃ­ch code vÃ  architecture</li>
          <li>ğŸ’¡ HÆ°á»›ng dáº«n sá»­ dá»¥ng Controllers, Services</li>
          <li>ğŸ› Debug vÃ  fix lá»—i</li>
          <li>ğŸ“š Best practices ASP.NET Core + Angular</li>
        </ul>
      </div>

      <!-- Messages -->
      <div *ngFor="let msg of messages; let i = index" 
           class="message" 
           [class.user]="msg.role === 'user'"
           [class.assistant]="msg.role === 'assistant'">
        
        <div class="message-avatar">
          {{ msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–' }}
        </div>
        
        <div class="message-content">
          <!-- Markdown Rendering for AI responses -->
          <div class="message-text markdown-content" 
               *ngIf="msg.role === 'assistant'"
               [innerHTML]="renderMarkdown(msg.content)"></div>
          
          <!-- Plain text for user messages -->
          <div class="message-text" 
               *ngIf="msg.role === 'user'">{{ msg.content }}</div>
          
          <div class="message-time">{{ formatTime(msg.timestamp) }}</div>
          
          <!-- Sources with Code Actions -->
          <div class="sources" *ngIf="msg.sources && msg.sources.length > 0">
            <button class="toggle-sources" (click)="toggleSources(i)">
              ğŸ“„ {{ msg.sources.length }} code sources
              {{ selectedMsgIdx === i ? 'â–²' : 'â–¼' }}
            </button>
            
            <div class="sources-list" *ngIf="selectedMsgIdx === i">
              <div *ngFor="let src of msg.sources" class="source-item">
                <div class="source-header">
                  <span class="source-icon">{{ getFileIcon(src.fileName) }}</span>
                  <span class="source-name">{{ src.fileName }}</span>
                  
                  <!-- Code Action Buttons -->
                  <div class="code-actions">
                    <button *ngFor="let q of getCodeRelatedQuestions(src.codeSnippet)"
                            class="action-btn"
                            (click)="askCodeQuestion(src.codeSnippet, q); $event.stopPropagation()"
                            [title]="q">
                      {{ q.split(' ')[0] }}
                    </button>
                  </div>
                  
                  <button class="btn-copy" (click)="copyCode(src.codeSnippet); $event.stopPropagation()">
                    ğŸ“‹ Copy
                  </button>
                </div>
                <pre class="source-code"><code>{{ src.codeSnippet }}</code></pre>
              </div>
            </div>
          </div>

          <!-- Follow-up Questions -->
          <div class="follow-ups" *ngIf="msg.followUpQuestions && msg.followUpQuestions.length > 0">
            <p class="follow-ups-title">ğŸ’¡ CÃ¢u há»i gá»£i Ã½:</p>
            <button *ngFor="let fq of msg.followUpQuestions" 
                    class="follow-up-btn"
                    (click)="currentQuestion = fq; sendQuestion()">
              {{ fq }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sample Questions -->
    <div class="samples" *ngIf="showSamples && messages.length === 0">
      <p class="samples-title">ğŸ¯ CÃ¢u há»i máº«u:</p>
      <button *ngFor="let sq of sampleQuestions" 
              class="sample-btn"
              (click)="askSample(sq)">
        {{ sq }}
      </button>
    </div>

    <!-- Input Area -->
    <div class="chat-input">
      <textarea 
        [(ngModel)]="currentQuestion"
        (keypress)="onKeyPress($event)"
        placeholder="Há»i AI vá» code, architecture, best practices..."
        [disabled]="loading"
        maxlength="1000"
        rows="2"></textarea>
      <button class="btn-send" 
              (click)="sendQuestion()"
              [disabled]="loading || currentQuestion.trim().length < 3">
        {{ loading ? 'â³' : 'â¤' }}
      </button>
    </div>
  </div>
</div>

<!-- Floating Open Button -->
<button class="floating-open-btn" *ngIf="!isVisible" (click)="openChat()">
  ğŸ¤– AI Chat
</button>
